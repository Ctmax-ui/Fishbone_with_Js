<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Fishbone diagram</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/style.css">
</head>

<body oncontextmenu="return false">

  <div class="text-box">
    <p><span>Left Click</span> to Delete Bones!</p>
    <p><span>Right Click</span> to Add Bones !!</p>
  </div>

  <!-- new node add -->
  <form id="nodeAddForm" class="position-absolute form-lg mt-2 ms-2" style="display: none;">
    <input class="me-2" type="text" id="whereToAdd" placeholder="The Parent Node">
    <input type="text" id="textToAdd" placeholder="Create new node">
    <button type="submit" class="btn btn-outline-dark">add node</button>
  </form>

  <!-- delete node -->
  <form id="nodeDeleteForm" class="position-absolute form-lg mt-2 ms-2 d-none" >
    <input type="text" id="whichNodeToDel" placeholder="The Name of the node">
    <button class="btn btn-outline-dark" type="submit">Delete node</button>
  </form>



  <script src="./js/jquery.min.js"></script>
  <script src="./js/d3.min.js" charset="utf-8"></script>
  <script src="./js/d3.fishbone.js" charset="utf-8"></script>

  <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script> -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script> -->
  <script>
    // create the configurable selection modifier
    var fishbone = d3.fishbone();


    //The json data
    var jsonData = {
      "name": "Quality",
      "children": [
        {
          "name": "Machine",
          "children": [
          ]
        },
        {
          "name": "Method",
          "children": [
          ]
        },
        {
          "name": "Material",
          "children": [
          ]
        },
        {
          "name": "Man Power",
          "children": [
          ]
        },
        {
          "name": "Measurement",
          "children": [
          ]
        },
        {
          "name": "Milieu",
          "children": [
            { "name": "lol" }
          ]
        }
      ]
    };



    function updateDiagram() {
      svg.datum(jsonData).call(fishbone.defaultArrow).call(fishbone);
      fishbone.force().start();
    }

    // the most reliable way to get the screen size
    var size = (function () {
      return { width: this.clientWidth, height: this.clientHeight };
    }).bind(window.document.documentElement),

      svg = d3.select("body")
        .append("svg")
        // firefox needs a real size
        .attr(size())
        // set the data so the reusable chart can find it
        .datum(jsonData)
        // set up the default arrowhead
        .call(fishbone.defaultArrow)
        // call the selection modifier
        .call(fishbone);

    // this is the actual `force`: just start it
    fishbone.force().start();

    // handle resizing the window.
    d3.select(window).on("resize", function () {
      fishbone.force()
        .size([size().width, size().height])
        .start();
      svg.attr(size())
    });


    $(document).on("contextmenu", (e) => {
      $("#nodeAddForm").toggle();
    });

    //to add new node
    $("#nodeAddForm").on("submit", function (e) {
      e.preventDefault();

      let nodeParentName = $("#whereToAdd").val();
      let newNodeName = $("#textToAdd").val();

      if (nodeParentName !== null && nodeParentName.trim() !== "") {
        if (newNodeName !== null && newNodeName.trim() !== "") {

          if (!nameExists(jsonData, newNodeName)) {

            let parentNode = getNode(jsonData, nodeParentName);
            updateData(newNodeName, parentNode);

            $("#whereToAdd").val("");
            $("#textToAdd").val("");
          }else{
            alert(`The name '${newNodeName}' already exsist!!`)
          }
        }
      }
      updateDiagram();
    })


    //to delete node
    $('#nodeDeleteForm').on("submit", e => {
      e.preventDefault()
      let nodeForDelete = $("#whichNodeToDel").val();
      if (nodeForDelete !== null && nodeForDelete.trim() !== "") {
        let Node = getNode(jsonData, nodeForDelete);
        let parentNode = getNode(jsonData, Node.parent.name);
        deleteChild(parentNode, nodeForDelete);
        $("#whichNodeToDel").val("");
        updateDiagram();
      }
    })



    // Function to delete a child node from the JSON data.
    function deleteChild(parentNode, childName) {
      // Find the index of the child node in the parent's children array
      var index = parentNode.children.findIndex(child => child.name === childName);
      if (index !== -1) {
        // Remove the child node from the parent's children array
        parentNode.children.splice(index, 1);
        // console.log("Child node '" + childName + "' deleted successfully.");
        updateDiagram()
      } else {
        // console.log("Child node '" + childName + "' not found.");
      };
    };

    function nameExists(node, name) {
      if (node.name === name) {
        return true; // Return true if the name matches the current node's name
      };
      if (node.children) {
        // Recursively check each child node
        for (var i = 0; i < node.children.length; i++) {
          if (nameExists(node.children[i], name)) {
            return true; // Return true if the name exists in any child node
          };
        };
      };
      return false; // Return false if the name does not exist in the JSON data
    };


    function updateData(text, parent) {
      if (!parent.children) {
        // If parent.children is not defined or null, initialize it as an empty array
        parent.children = [];
      };
      // Add the new item to the parent's children
      parent.children.push({ "name": text });
      // Redraw the fishbone diagram with the updated data
      updateDiagram();
    };


    function getNode(node, text) {
      if (node.name === text) {
        return node;
      };
      if (node.children) {
        for (var i = 0; i < node.children.length; i++) {
          var result = getNode(node.children[i], text);
          if (result) {
            return result;
          };
        };
      };
      return null;
    };

    updateDiagram();



  </script>
</body>

</html>